name: Build and Release LaTeX Document

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual triggers

env:
  LATEX_DIR: rapport
  LATEX_MAIN: 00-main.tex
  DOCKER_IMAGE: chaussebenjamin/tex-compiler

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get short commit SHA
        id: vars
        run: |
          echo "short_sha=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "commit_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Compile LaTeX document with Docker
        run: |
          echo "Compiling LaTeX document using Docker container..."
          docker run --rm \
            -v "${{ github.workspace }}:/tex" \
            ${{ env.DOCKER_IMAGE }} \
            ${{ env.LATEX_DIR }}/${{ env.LATEX_MAIN }}

      - name: Verify PDF was created
        run: |
          MAIN_FILE="${{ env.LATEX_MAIN }}"
          PDF_FILE="${MAIN_FILE%.tex}.pdf"
          if [ ! -f ${{ env.LATEX_DIR }}/$PDF_FILE ]; then
            echo "Error: PDF was not generated at ${{ env.LATEX_DIR }}/$PDF_FILE"
            echo "Directory contents:"
            ls -la ${{ env.LATEX_DIR }}/
            echo "Docker container logs (if any):"
            docker logs $(docker ps -lq) || echo "No container logs available"
            exit 1
          else
            echo "Success: PDF generated successfully"
            ls -la ${{ env.LATEX_DIR }}/$PDF_FILE
          fi

      - name: Prepare release assets
        run: |
          MAIN_FILE="${{ env.LATEX_MAIN }}"
          PDF_FILE="${MAIN_FILE%.tex}.pdf"
          SHORT_SHA="${{ steps.vars.outputs.short_sha }}"
          
          # Create descriptive filenames with commit hash
          cp ${{ env.LATEX_DIR }}/$PDF_FILE "${MAIN_FILE%.tex}-${SHORT_SHA}.pdf"
          
          # Create ZIP with PDF and license
          mkdir -p release_content
          cp ${{ env.LATEX_DIR }}/$PDF_FILE "release_content/${MAIN_FILE%.tex}.pdf"
          if [ -f LICENSE ]; then
            cp LICENSE release_content/
          fi
          zip -r "${MAIN_FILE%.tex}-${SHORT_SHA}.zip" release_content/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if build fails for debugging
        with:
          name: latex-build-artifacts
          path: |
            ${{ env.LATEX_DIR }}/*.log
            ${{ env.LATEX_DIR }}/*.aux
            ${{ env.LATEX_DIR }}/*.out
            ${{ env.LATEX_DIR }}/*.toc
          retention-days: 7

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Release v${{ github.run_number }} (commit ${{ steps.vars.outputs.short_sha }})"
          body: |
            Automated release of LaTeX document compiled from commit ${{ steps.vars.outputs.commit_sha }}.
            
            **Files included:**
            - `${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.pdf` - Standalone PDF document
            - `${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.zip` - PDF with license file
            
            **Commit:** ${{ github.event.head_commit.message }}
            **Author:** ${{ github.event.head_commit.author.name }}
          files: |
            ${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.pdf
            ${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… LaTeX document compiled successfully!"
          echo "ðŸ“„ PDF: ${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.pdf"
          echo "ðŸ“¦ ZIP: ${{ env.LATEX_MAIN | replace('.tex', '') }}-${{ steps.vars.outputs.short_sha }}.zip"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"